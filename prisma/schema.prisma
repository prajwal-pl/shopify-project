// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Note that some adapters may set a maximum length for the String type by default, please ensure your strings are long
// enough when changing adapters.
// See https://www.prisma.io/docs/orm/reference/prisma-schema-reference#string for more information
datasource db {
  provider = "sqlite"
  url      = "file:dev.sqlite"
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
}

// ============================================================================
// PHASE 3.0: SAAS MULTI-TENANT MODELS
// ============================================================================

// Merchant: Represents each shop that installs the app
model Merchant {
  id   String @id @default(cuid())
  shop String @unique // Shopify shop domain (e.g., "mystore.myshopify.com")

  // Shopify integration
  shopifyDomain String // Primary shop domain
  accessToken   String // Encrypted in production

  // Merchant information
  name   String? // Store name
  email  String? // Owner email
  phone  String? // Contact phone
  status String  @default("active") // "active" | "suspended" | "cancelled"

  // Onboarding tracking
  settings String? // JSON: { onboardingCompleted, onboardingStep, etc. }

  // Timestamps
  installedAt   DateTime  @default(now())
  uninstalledAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  subscriptions Subscription[]

  @@index([shop])
  @@index([status])
}

// Subscription: Manages billing subscriptions via Shopify Billing API
model Subscription {
  id       String   @id @default(cuid())
  shop     String // Reference to merchant shop
  merchant Merchant @relation(fields: [shop], references: [shop], onDelete: Cascade)

  // Shopify subscription
  shopifySubscriptionId String @unique // Shopify subscription GID

  // Plan details
  plan   String // "starter" | "professional" | "enterprise"
  status String @default("PENDING") // "ACTIVE" | "CANCELLED" | "FROZEN" | "PENDING"

  // Billing cycle
  currentPeriodEnd   DateTime
  trialDaysRemaining Int      @default(0)

  // Plan features (stored as JSON)
  features String? // JSON: { maxProducts, inventoryFeeds, analytics, etc. }

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shop, status])
  @@index([status])
}

// ============================================================================
// RING BUILDER MODELS
// ============================================================================

// Enum for configuration status
enum ConfigurationStatus {
  in_progress
  completed
  ordered
}

// Configuration: Stores customer ring configurations
model Configuration {
  id            String  @id @default(cuid())
  shop          String // Multi-tenant isolation
  customerId    String? // Shopify Customer GID (if logged in)
  customerEmail String? // Customer email

  // Selected products
  settingId String // Shopify Product GID for setting
  stoneId   String // Shopify Product GID for stone

  // Configuration details
  metalType String // Selected metal type (e.g., "14k_white_gold")
  ringSize  String // Selected ring size (e.g., "7")

  // Side stones (if applicable, stored as JSON)
  sideStonesConfig String? // JSON: { quality: "Premium", quantity: 12, price: 500 }

  // Pricing breakdown
  settingPrice    Float // Price of setting with selected metal
  stonePrice      Float // Price of stone
  sideStonesPrice Float? // Price of side stones (if applicable)
  totalPrice      Float // Final total price (with markup)

  // Status and metadata
  status          ConfigurationStatus @default(in_progress)
  configurationId String              @unique // Human-readable ID (e.g., CONFIG-20251012-ABC123)
  cartItemId      String? // Shopify cart item ID (if added to cart)

  // Phase 2.0: Save & Share functionality
  shareToken String?   @unique // Token for sharing configuration (8-12 characters)
  shareCount Int       @default(0) // Track share analytics
  savedAt    DateTime? // When configuration was saved (vs completed)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes for performance
  @@index([shop, customerId])
  @@index([shop, status])
  @@index([shop, createdAt])
  @@index([configurationId])
  @@index([shareToken]) // Phase 2.0: Fast lookup for shareable URLs
}

// SettingMetadata: Stores ring setting attributes
model SettingMetadata {
  id        String @id @default(cuid())
  shop      String // Multi-tenant isolation
  productId String @unique // Shopify Product GID

  // Setting attributes
  style         String // Setting style (e.g., "solitaire", "halo")
  settingHeight String? // Height: "low", "medium", "high"

  // Compatible stone shapes (stored as JSON array)
  compatibleShapes String // JSON array: ["round", "princess", "cushion"]

  // Base prices by metal type (stored as JSON)
  basePrices String // JSON: { "14k_white_gold": 500, "14k_yellow_gold": 550, ... }

  // Images (Shopify product images as JSON array of URLs)
  images String? // JSON array: ["https://cdn.shopify.com/..."]

  // Featured flag
  featured Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes
  @@index([shop, style])
  @@index([shop, featured])
  @@index([productId])
}

// StoneMetadata: Stores diamond/gemstone specifications
model StoneMetadata {
  id        String @id @default(cuid())
  shop      String // Multi-tenant isolation
  productId String @unique // Shopify Product GID

  // Stone basic info
  stoneType String // "diamond", "sapphire", "ruby", etc.
  shape     String // "round", "princess", "cushion", etc.

  // 4 Cs for diamonds
  carat   Float // Carat weight (e.g., 1.50)
  cut     String? // Cut grade (e.g., "excellent", "very_good")
  color   String? // Color grade (e.g., "d", "e", "f")
  clarity String? // Clarity grade (e.g., "vvs1", "vs1")

  // Phase 2.0: Diamond type categorization (Mined/Lab Grown/Fancy Color)
  diamondType String @default("mined") // "mined" | "lab_grown" | "fancy_color"

  // Certification
  certificate       String? // Certificate type (e.g., "gia", "ags")
  certificateNumber String? // Certificate number
  certificateUrl    String? // URL to certificate PDF

  // Detailed measurements
  measurements String? // Format: "7.35 x 7.40 x 4.50" (mm)
  tablePercent Float? // Table percentage
  depthPercent Float? // Depth percentage

  // Additional quality attributes
  polish       String? // Polish grade
  symmetry     String? // Symmetry grade
  fluorescence String? // Fluorescence level

  // Images (Shopify product images as JSON array)
  images String? // JSON array of image URLs

  // Pricing and availability
  price     Float // Stone price
  available Boolean @default(true) // Availability flag

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes for filtering and search
  @@index([shop, shape, carat])
  @@index([shop, available])
  @@index([shop, price])
  @@index([shop, stoneType])
  @@index([shop, diamondType]) // Phase 2.0: For diamond type tab filtering
  @@index([productId])
}

// AppSettings: Stores merchant configuration
model AppSettings {
  id   String @id @default(cuid())
  shop String @unique // One settings record per shop

  // General settings
  builderEnabled Boolean @default(true)

  // Side stones configuration (stored as JSON)
  // Format: { enabled: true, qualities: ["Good", "Better", "Best"], pricing: { "Good": 50, "Better": 75, "Best": 100 }, minQuantity: 0, maxQuantity: 50 }
  sideStones String? // JSON string

  // Pricing rules
  engravingFee  Float? // Engraving fee (if applicable, future feature)
  markupPercent Float  @default(0) // Markup percentage (e.g., 5 for 5%)

  // Notification settings
  notifyOnConfig    Boolean @default(false) // Email notification on configuration save
  notificationEmail String? // Email to receive notifications

  // Customization (colors for storefront builder)
  primaryColor String? // Hex color (e.g., "#000000")
  accentColor  String? // Hex color (e.g., "#D4AF37")

  // Phase 2.0: Feature settings (stored as JSON)
  customerEngagement String? // JSON: { dropHintEnabled, requestInfoEnabled, notificationEmail, etc. }
  virtualTryOn       String? // JSON: { enabled, integrationType, apiKey, buttonLabel, etc. }
  socialSharing      String? // JSON: { facebookAppId, enabledPlatforms, defaultMessage, etc. }

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// AnalyticsEvent: Stores basic tracking events (optional for MVP)
model AnalyticsEvent {
  id   String @id @default(cuid())
  shop String // Multi-tenant isolation

  // Event details
  eventType       String // Event type (e.g., "builder_started", "setting_selected", "cart_added")
  configurationId String? // Related configuration ID (if applicable)
  customerId      String? // Customer ID (if logged in)

  // Event data (stored as JSON for flexibility)
  eventData String? // JSON: { step: 1, settingId: "...", ... }

  // Timestamp
  timestamp DateTime @default(now())

  // Indexes
  @@index([shop, eventType])
  @@index([shop, configurationId])
  @@index([shop, timestamp])
}

// ============================================================================
// PHASE 2.0 MODELS
// ============================================================================

// CustomerInquiry: Stores customer engagement actions (Phase 2.0)
model CustomerInquiry {
  id   String @id @default(cuid())
  shop String // Multi-tenant isolation

  // Inquiry details
  type            String // "hint" | "info" | "viewing" | "email"
  configurationId String? // Related configuration (optional)
  productId       String? // Related product (optional)

  // Customer information
  customerName  String?
  customerEmail String // Required
  customerPhone String?
  message       String?

  // Scheduling (for viewing appointments)
  preferredDate DateTime?
  preferredTime String? // Store as string (e.g., "2:00 PM")

  // Status tracking
  status String @default("new") // "new" | "contacted" | "closed"

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes for admin dashboard queries
  @@index([shop, type])
  @@index([shop, status])
  @@index([shop, createdAt])
}
